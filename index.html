<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ChatX â€“ Welcome</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #151515;
      --muted: #8b8b8b;
      --accent: #00ffe7;
      --accent-2: #3aa0ff;
      --input: #1e1e1e;
      --ring: rgba(0,255,231,0.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 80% -10%, rgba(0,255,231,0.08), transparent 60%),
                  radial-gradient(1200px 800px at -10% 110%, rgba(58,160,255,0.08), transparent 60%), var(--bg);
      color: #fff;
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .card {
      width: 100%;
      max-width: 460px;
      background: var(--card);
      border: 1px solid #222;
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      animation: pop 0.25s ease-out;
    }
    @keyframes pop { from { transform: scale(.98); opacity: .8; } to { transform: scale(1); opacity: 1; } }
    .title { font-weight: 800; font-size: 1.6rem; letter-spacing: .3px; }
    .title span { color: var(--accent); }
    .sub { color: var(--muted); margin-top: 6px; font-size: .95rem; }
    .pfp {
      width: 110px; height: 110px; border-radius: 999px; object-fit: cover;
      border: 3px solid var(--accent); display: block; margin: 18px auto 10px;
      background: #0e0e0e;
    }
    .upload-row { display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items: center; }
    .file-btn, .btn {
      appearance: none; border: none; cursor: pointer; border-radius: 12px; font-weight: 700;
      padding: 12px 14px; transition: transform .08s ease, box-shadow .2s ease, opacity .2s;
    }
    .file-btn {
      background: linear-gradient(90deg, #1f1f1f, #262626); color: #ddd; border: 1px solid #2b2b2b;
    }
    .file-btn:hover { transform: translateY(-1px); }
    .file-btn:active { transform: translateY(0); }
    .btn {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #081016; box-shadow: 0 0 0 0 var(--ring);
    }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .btn:not([disabled]):hover { transform: translateY(-1px); box-shadow: 0 0 0 6px var(--ring); }
    .input {
      width: 100%; background: var(--input); border: 1px solid #2b2b2b; color: #fff;
      padding: 12px 14px; border-radius: 12px; outline: none; transition: box-shadow .2s, border-color .2s;
    }
    .input:focus { border-color: var(--accent); box-shadow: 0 0 0 5px var(--ring); }
    .row { margin-top: 14px; }
    .hint { font-size: .85rem; color: var(--muted); margin-top: 8px; text-align: center; }
    .error { margin-top: 10px; color: #ff7a7a; font-size: .9rem; min-height: 1.2em; text-align: center; }
    .hidden { display: none; }
    .preview-wrap { display: grid; place-items: center; margin-top: 6px; }
    .footer { margin-top: 14px; text-align: center; font-size: .8rem; color: #7e7e7e; }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <div class="title" id="title">Welcome to <span>ChatX</span></div>
    <div class="sub">Create your anonymous profile to enter the global chat.</div>

    <div class="preview-wrap">
      <img id="preview" class="pfp hidden" alt="Profile preview" />
    </div>

    <div class="row upload-row" style="margin-top: 16px;">
      <button id="pickBtn" class="file-btn" type="button">ðŸ“· Upload Profile Picture</button>
      <input id="file" type="file" accept="image/*" class="hidden" />
      <span id="fileName" style="color:#9d9d9d; font-size:.9rem;"></span>
    </div>

    <div class="row">
      <input id="username" class="input" type="text" placeholder="Choose a username" autocomplete="nickname" />
    </div>

    <div class="row">
      <button id="startBtn" class="btn" type="button" disabled>Get Started â†’</button>
    </div>

    <div id="errorBox" class="error"></div>
    <div class="hint">By continuing, youâ€™ll enter as an anonymous user. You can change your profile later.</div>
    <div class="footer">Dark mode â€¢ Smooth â€¢ Realtime</div>
  </main>

  <!-- Firebase (v10 modular) -->
  <script type="module">
    // ===== Firebase SDKs =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ===== Your config (from your message) =====
    const firebaseConfig = {
      apiKey: "AIzaSyC029g_8WDBRNoHbMpM0JJ_W4PzSb-bJ7U",
      authDomain: "chatx-cfb20.firebaseapp.com",
      databaseURL: "https://chatx-cfb20-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatx-cfb20",
      storageBucket: "chatx-cfb20.firebasestorage.app",
      messagingSenderId: "707787260350",
      appId: "1:707787260350:web:32d4826826d3e6ad93f9ef"
    };

    // ===== Init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // IMPORTANT: Explicit bucket ensures compatibility even if storageBucket domain differs
    const storage = getStorage(app, "gs://chatx-cfb20.appspot.com");

    // ===== UI Elements =====
    const fileInput = document.getElementById("file");
    const pickBtn = document.getElementById("pickBtn");
    const fileName = document.getElementById("fileName");
    const preview = document.getElementById("preview");
    const usernameInput = document.getElementById("username");
    const startBtn = document.getElementById("startBtn");
    const errorBox = document.getElementById("errorBox");

    let selectedFile = null;
    let busy = false;

    // Helpers
    const setError = (msg="") => { errorBox.textContent = msg; };
    const canContinue = () => !!(selectedFile && usernameInput.value.trim().length >= 3);

    const refreshButton = () => {
      startBtn.disabled = !canContinue() || busy;
      startBtn.textContent = busy ? "Please waitâ€¦" : "Get Started â†’";
    };

    // Pick file
    pickBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      selectedFile = f || null;
      fileName.textContent = selectedFile ? selectedFile.name : "";
      if (selectedFile) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.classList.remove("hidden");
        };
        reader.readAsDataURL(selectedFile);
      } else {
        preview.classList.add("hidden");
      }
      setError("");
      refreshButton();
    });

    usernameInput.addEventListener("input", () => {
      if (usernameInput.value.trim().length && usernameInput.value.trim().length < 3) {
        setError("Username must be at least 3 characters.");
      } else { setError(""); }
      refreshButton();
    });

    // Main flow
    startBtn.addEventListener("click", async () => {
      if (!canContinue()) {
        setError("Upload a profile picture and enter a username (min 3 chars).");
        return;
      }
      if (busy) return;
      busy = true; refreshButton(); setError("");

      try {
        // 1) Anonymous auth
        const cred = await signInAnonymously(auth);
        const uid = cred.user.uid;

        // 2) Upload avatar
        const avatarRef = sRef(storage, `profiles/${uid}.jpg`);
        await uploadBytes(avatarRef, selectedFile);
        const photoURL = await getDownloadURL(avatarRef);

        // 3) Save profile
        const username = usernameInput.value.trim();
        await set(ref(db, `users/${uid}`), {
          username,
          photoURL,
          createdAt: Date.now()
        });

        // 4) Persist locally & go
        localStorage.setItem("chatxUser", JSON.stringify({ uid, username, photoURL }));
        window.location.href = "chatx.html";
      } catch (err) {
        console.error(err);
        // Friendly messages for common causes
        if (String(err?.message || "").includes("storage")) {
          setError("Storage error. If it persists, enable Firebase Storage for your project and allow anonymous reads/writes via security rules.");
        } else if (String(err?.message || "").includes("auth")) {
          setError("Auth error. Make sure Anonymous Sign-in is enabled in Firebase Authentication.");
        } else if (String(err?.message || "").includes("permission") || String(err?.message || "").includes("rules")) {
          setError("Permission denied. Check your Realtime Database & Storage security rules.");
        } else {
          setError(err.message || "Something went wrong.");
        }
      } finally {
        busy = false; refreshButton();
      }
    });

    // Quality-of-life: support pressing Enter to submit if both fields are valid
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && canContinue() && !busy) startBtn.click();
    });

  </script>
</body>
</html>
